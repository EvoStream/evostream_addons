{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "vmSize": {
      "type": "string",
      "metadata": {
        "description": "Size of VMs in the Origin & Edge Scale Sets and in the Streams Manager."
      }
    },
    "uniqueSuffix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Unique suffix for resource names."
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "Admin username on all VMs."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Admin password on all VMs."
      }
    },
    "httpPassword": {
      "type": "securestring",
      "metadata": {
        "description": "HTTP password for API commands."
      }
    },
    "sshKey": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Public SSH Key for Virtual Machine"
      }
    },
    "emsLicense": {
      "type": "string",
      "metadata": {
        "description": "EMS license"
      }
    },
    "baseUrl": {
      "type": "string",
      "metadata": {
        "description": "The base URL for dependent assets",
        "artifactsBaseUrl": ""
      },
      "defaultValue": ""
    }
  },
  "variables": {
    "customScriptFolder": "https://raw.githubusercontent.com/EvoStream/evostream_addons/master/azure_templates/load_balancer_ems171_ubuntu1604/",
    "uniqueSuffix1": "[parameters('uniqueSuffix')]",
    "adminUsername1": "[parameters('adminUsername')]",
    "adminPassword1": "[parameters('adminPassword')]",
    "httpPassword1": "[parameters('httpPassword')]",
    "sshKey1": "[parameters('sshKey')]",
    "vmssName1": "[concat('vmss',parameters('uniqueSuffix'))]",
    "instanceCount1": 2,
    "vmSize1": "[parameters('vmSize')]",
    "vneteo": {
      "name": "[concat('vneteo-', resourceGroup().location)]",
      "addressSpacePrefix": "10.10.0.0/24",
      "subnetName": "subnet1",
      "subnetPrefix": "10.10.0.0/24",
      "peeringName": "peer-eo"
    },
    "vnetsm": {
      "name": "[concat('vnetsm-', resourceGroup().location)]",
      "addressSpacePrefix": "10.20.0.0/24",
      "subnetName": "subnet1",
      "subnetPrefix": "10.20.0.0/24",
      "peeringName": "peer-sm"
    },
    "emsLicense1": "[parameters('emsLicense')]"
  },
  "resources": [
    {
      "apiVersion": "2016-10-01",
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[variables('vneteo').name]",
      "location": "[resourceGroup().location]",
      "comments": "This is the first vnet",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('vneteo').addressSpacePrefix]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('vneteo').subnetName]",
            "properties": {
              "addressPrefix": "[variables('vneteo').subnetPrefix]"
            }
          }
        ]
      },
      "resources": [
        {
          "apiVersion": "2016-06-01",
          "type": "virtualNetworkPeerings",
          "name": "[variables('vneteo').peeringName]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[concat('Microsoft.Network/virtualNetworks/', variables('vneteo').name)]",
            "[concat('Microsoft.Network/virtualNetworks/', variables('vnetsm').name)]"
          ],
          "comments": "This is the peering from vnet 1 to vnet 2",
          "properties": {
            "allowVirtualNetworkAccess": true,
            "allowForwardedTraffic": false,
            "allowGatewayTransit": false,
            "useRemoteGateways": false,
            "remoteVirtualNetwork": {
              "id": "[resourceId('Microsoft.Network/virtualNetworks',variables('vnetsm').name)]"
            }
          }
        }
      ]
    },
    {
      "apiVersion": "2016-10-01",
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[variables('vnetsm').name]",
      "location": "[resourceGroup().location]",
      "comments": "This is the second vnet",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('vnetsm').addressSpacePrefix]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('vnetsm').subnetName]",
            "properties": {
              "addressPrefix": "[variables('vnetsm').subnetPrefix]"
            }
          }
        ]
      },
      "resources": [
        {
          "apiVersion": "2016-06-01",
          "type": "virtualNetworkPeerings",
          "name": "[variables('vnetsm').peeringName]",
          "location": "[resourceGroup().location]",
          "dependsOn": [
            "[concat('Microsoft.Network/virtualNetworks/', variables('vneteo').name)]",
            "[concat('Microsoft.Network/virtualNetworks/', variables('vnetsm').name)]"
          ],
          "comments": "This is the peering from vnet 2 to vnet 1",
          "properties": {
            "allowVirtualNetworkAccess": true,
            "allowForwardedTraffic": false,
            "allowGatewayTransit": false,
            "useRemoteGateways": false,
            "remoteVirtualNetwork": {
              "id": "[resourceId('Microsoft.Network/virtualNetworks',variables('vneteo').name)]"
            }
          }
        }
      ]
    },
    {
      "name": "managerSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('baseUrl'), '/nestedtemplates/manager.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "uniqueSuffix": {
            "value": "[concat(variables('uniqueSuffix1'), 'm')]"
          },
          "adminUsername": {
            "value": "[variables('adminUsername1')]"
          },
          "adminPassword": {
            "value": "[variables('adminPassword1')]"
          },
          "httpPassword": {
            "value": "[variables('httpPassword1')]"
          },
          "sshKey": {
            "value": "[variables('sshKey1')]"
          },
          "vmSize": {
            "value": "[variables('vmSize1')]"
          },
          "vnetName": {
            "value": "[variables('vnetsm').name]"
          },
          "subnetName": {
            "value": "[variables('vnetsm').subnetName]"
          },
          "addressPrefix": {
            "value": "[variables('vnetsm').addressSpacePrefix]"
          },
          "emsLicense": {
            "value": "[variables('emsLicense1')]"
          },
          "customScriptFolder": {
            "value": "[variables('customScriptFolder')]"
          }
        }
      }
    },
    {
      "name": "streamersSetup",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/managerSetup"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('baseUrl'), '/nestedtemplates/streamers.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "uniqueSuffix": {
            "value": "[concat(variables('uniqueSuffix1'), 'z')]"
          },
          "smPublicIp": {
            "value": "[reference('managerSetup').outputs.publicIpAddressSM.value]"
          },
          "adminUsername": {
            "value": "[variables('adminUsername1')]"
          },
          "adminPassword": {
            "value": "[variables('adminPassword1')]"
          },
          "httpPassword": {
            "value": "[variables('httpPassword1')]"
          },
          "sshKey": {
            "value": "[variables('sshKey1')]"
          },
          "vmssName": {
            "value": "[concat(variables('vmssName1'), 'e')]"
          },
          "instanceCount": {
            "value": "[variables('instanceCount1')]"
          },
          "vmSize": {
            "value": "[variables('vmSize1')]"
          },
          "vnetName": {
            "value": "[variables('vneteo').name]"
          },
          "subnetName": {
            "value": "[variables('vneteo').subnetName]"
          },
          "addressPrefix": {
            "value": "[variables('vneteo').addressSpacePrefix]"
          },
          "subnetPrefix": {
            "value": "[variables('vneteo').subnetPrefix]"
          },
          "emsLicense": {
            "value": "[variables('emsLicense1')]"
          },
          "customScriptFolder": {
            "value": "[variables('customScriptFolder')]"
          }
        }
      }
    }
  ]
}
